(()=>{"use strict";class e{constructor(e=0,t=0){this.x=e,this.y=t}static Distance(t,i){return new e(i.x-t.x,i.y-t.y)}static Add(t,i){return new e(t.x+i.x,t.y+i.y)}static copy(t){return new e(t.x,t.y)}}class t{static drawSprite(t,i,s,a,r){const n=new e(s.width,s.height);a&&(n.x=a),r&&(n.y=r),t.drawImage(s.image,i.x-.5*n.x,i.y-.5*n.y,n.x,n.y)}static drawRectangle(e,t,i,s,a,r){e.save(),r&&(e.globalAlpha=r),e.fillStyle=a,e.fillRect(t.x-.5*i,t.y-.5*s,i,s),e.restore()}static DrawCircle(e,t,i,s,a){e.save(),e.beginPath(),e.fillStyle=s,a&&(e.globalAlpha=a),e.arc(t.x,t.y,i,0,2*Math.PI),e.fill(),e.restore()}static drawText(e,t,i,s,a="#fff",r){e.save(),r&&(e.font=r),e.fillStyle=a,e.fillText(t,i.x,i.y,s),e.restore()}static DrawProgressBar(e,t,i,s,a,r,n="#0f0",o="#000",l=0,c=0){let h=s/i*a;e.save(),e.fillStyle=o,e.fillRect(t.x,t.y,a,r),e.fillStyle=n,l>0&&(r-=l,t.y+=.5*l,t.x+=.5*l,h=s/i*(a-l)),1===c&&(h=-h,t.x+=a,t.x-=l),e.fillRect(t.x,t.y,h,r),e.restore()}static DrawStrokeRect(e,t,i="#fff",s,a,r,n){e.save(),e.beginPath(),e.rect(t.x-.5*a,t.y-.5*r,a,r),e.strokeStyle=i,n&&(e.globalAlpha=n),e.lineWidth=s,e.stroke(),e.restore()}}class i{constructor(t=new e,i,s){this.game=s,this.collisionPosition=new e,this.collisionEnabled=!0,this.collisionRadius=30,this.referenceName=i,this.position=t}CheckForCollisions(){}render(e){this.game.debug&&t.DrawCircle(e,this.position,this.collisionRadius,"#f00",.5),this.sprite&&t.drawSprite(e,this.position,this.sprite)}}class s{static CreateCategoryButton(e){const t=document.createElement("div");t.classList.add("categoryBtn");const i=document.createElement("p");i.innerText=e,t.appendChild(i);const s=document.createElement("div");return e=e.replace(" ","-"),s.id=e,s.classList.add("categoryList"),t.setAttribute("category-data",e),t.addEventListener("click",(e=>{const t=e.currentTarget.getAttribute("category-data"),i=document.querySelector(".categoryListActive");i&&i.id===t?i.classList.remove("categoryListActive"):(i?.classList.remove("categoryListActive"),document.querySelector(`.categoryList#${t}`).classList.add("categoryListActive"))})),{object:t,itemList:s}}static CreateTileSelectableButton(e){const t=document.createElement("div"),i=document.createElement("p");return i.innerText=e.name,t.setAttribute("tile-meta-name",e.name),t.classList.add("uiSelectableButton"),t.appendChild(i),t.appendChild(e.image),t}}class a{constructor(e){this.sprites=e,this.categorisedMenuItems=new Map,this.menu=null,this.selectableButtons=new Map,this.Init()}Init(){this.menu=document.querySelector(".editModeUI"),this.ReloadMenu(),a.Instance||(a.Instance=this),o.Instance?.setTileButtonAsActive(),document.querySelector(".categoryList")?.classList.add("categoryListActive")}ReloadMenu(){if(!this.menu)throw new Error("The menu object is not defined.");{this.Categorize();const e=this.menu.querySelector(".scroll-view");this.selectableButtons.clear(),e.innerHTML="";for(let t of this.categorisedMenuItems.keys()){const i=s.CreateCategoryButton(t);e.appendChild(i.object),e.appendChild(i.itemList);const a=this.categorisedMenuItems.get(t);for(const e of a){const t=s.CreateTileSelectableButton(e);t.addEventListener("click",(e=>{const t=e.currentTarget;if(t.classList.contains("selectedTile"))return;const i=document.querySelector(".selectedTile");i?.classList.remove("selectedTile");const s=t.getAttribute("tile-meta-name");o.Instance?.setSprite(s),t.classList.add("selectedTile")})),this.selectableButtons.set(e,t),i.itemList.appendChild(t)}}}}Categorize(){const e=new Map;this.categorisedMenuItems.clear();for(let t of this.sprites){const i=t.GetCategory();e.has(t.GetCategory())||e.set(t.GetCategory(),new Array),e.get(i)?.push(t)}this.categorisedMenuItems=e}Log(){console.log(`All tiles categories count: ${this.categorisedMenuItems?.size}`),console.log(this.categorisedMenuItems)}}a.Instance=null;class r{constructor(e,t,i,s,a){this.name=e,this.category=t,this.path=i,this.width=s,this.height=a;const r=new Image;r.src=i,r.onload=()=>{this.image=r},this.image=r}GetCategory(){switch(this.category){case 0:return"Characters";case 2:return"Player Sprites";case 4:return"Custom Tiles";case 1:return"Solid tiles";case 6:return"Collectable items";case 5:return"Powerups";case 7:return"Decorations";default:return"Other"}}}const n={NightmareFoxy:new r("NightmareFoxy",0,"Images/Sprites/Characters/NightmareFoxy.webp",70,70),GoldenFreddy:new r("GoldenFreddy",0,"Images/Sprites/Characters/GoldenFreddy.webp",70,70),Springtrap:new r("Springtrap",0,"Images/Sprites/Characters/Springtrap.webp",70,70),Bonnie:new r("Bonnie",0,"Images/Sprites/Characters/Bonnie.webp",70,70),Cupcake:new r("Cupcake",0,"Images/Sprites/Characters/Cupcake.webp",50,50),William:new r("William",0,"Images/Sprites/Characters/William.webp",70,70),Freddy:new r("Freddy",0,"Images/Sprites/Characters/Freddy.webp",70,70),Chica:new r("Chica",0,"Images/Sprites/Characters/Chica.webp",70,70),Foxy:new r("Foxy",0,"Images/Sprites/Characters/Foxy.webp",70,70),Guard:new r("Guard",2,"Images/Sprites/Player/Guard.webp",70,70),Wall:new r("Wall",1,"Images/Sprites/Solid Tiles/Wall.webp",70,70),DashedBG:new r("DashedBG",3,"Images/Assets/dashedbg.png",40,40),Cherry:new r("Cherry",6,"Images/Sprites/Collectables/cherry.webp",70,70),Mask:new r("Mask",5,"Images/Sprites/Powerups/mask.webp",70,70),FlashLight:new r("FlashLight",5,"Images/Sprites/Powerups/flashlight.webp",70,70),PhoneCall:new r("PhoneCall",5,"Images/Sprites/Powerups/phone call.webp",70,70),PinkBlock:new r("PinkBlock",4,"Images/Sprites/Custom Tiles/pink.webp",70,70),PizzeriaWall:new r("PizzeriaWall",1,"Images/Sprites/Solid Tiles/PizzeriaWall.webp",70,70),robotPice1:new r("robotPice1",7,"Images/Sprites/Decorations/robotPice1.webp",70,70),robotPice2:new r("robotPice2",7,"Images/Sprites/Decorations/robotPice2.webp",70,70),robotPice3:new r("robotPice3",7,"Images/Sprites/Decorations/robotPice3.webp",70,70),robotPice4:new r("robotPice4",7,"Images/Sprites/Decorations/robotPice4.webp",70,70),FamilyPizza:new r("FamilyPizza",6,"Images/Sprites/Collectables/full-pizza.webp",70,70),Hamburger:new r("Hamburger",6,"Images/Sprites/Collectables/hamburger.webp",70,70),PizzaSlice:new r("PizzaSlice",6,"Images/Sprites/Collectables/pizza-slice.webp",70,70),SoftDrink:new r("SoftDrink",6,"Images/Sprites/Collectables/soft-drink.webp",70,70),BlankWall:new r("BlankWall",1,"Images/Sprites/Solid Tiles/BlankWall.webp",70,70),Lolipop:new r("Lolipop",6,"Images/Sprites/Solid Tiles/lolipop.webp",70,70)};class o{constructor(t,i,s=Math.ceil(t.canvasWidth/i)){this.game=t,this.levelSize=i,this.rowMaxCells=s,this.cursorPosition=new e(.5*this.levelSize,.5*this.levelSize),this.grid=new Array,this.loadedSprites=Object.keys(n),this.selectedSpriteIdx=0,this.pattern=new Array,this.gridIndex=0,this.clickAudio=new Audio("Sounds/Effects/click.ogg"),this.selectedSprite=n[this.loadedSprites[0]],this.initGrid(),this.clickAudio.volume=.5,o.Instance||(o.Instance=this)}getSpritesArray(){let e=new Array;for(const t of this.loadedSprites){const i=n[t];3!==i.category&&e.push(i)}return e}setSprite(e){this.selectedSprite=n[e],this.clickAudio.play()}setTileButtonAsActive(){const e=document.querySelector(".selectedTile");e?.classList.remove("selectedTile");const t=a.Instance?.selectableButtons.get(this.selectedSprite);t.classList.add("selectedTile"),this.clickAudio.play()}initGrid(){for(let e=0;e<this.rowMaxCells;e++)for(let t=0;t<this.rowMaxCells;t++)(e+t)%2==0?this.pattern.push("#222"):this.pattern.push("#101314"),this.grid?.push(null);this.loadEmptyLevel()}placeSprite(){this.grid[this.gridIndex]=this.selectedSprite}removeSprite(){this.grid[this.gridIndex]=null}calculateGridIndex(){this.gridIndex=Math.floor(this.cursorPosition.x/this.levelSize)+Math.floor(this.cursorPosition.y/this.levelSize)*this.rowMaxCells}loadEmptyLevel(){this.addFullRow(0);for(let e=1;e<this.rowMaxCells-1;e++)this.addBoxedColumn(e);this.addFullRow(this.rowMaxCells-1)}addFullRow(e){for(let t=0;t<this.rowMaxCells;t++)this.grid[t+e*this.rowMaxCells]=n.Wall}addBoxedColumn(e){const t=e*this.rowMaxCells;this.grid[t]=n.Wall,this.grid[t+(this.rowMaxCells-1)]=n.Wall}changeSprite(e){this.selectedSpriteIdx+=e,console.log(this.selectedSpriteIdx),this.selectedSpriteIdx>this.loadedSprites.length-1&&(this.selectedSpriteIdx=0),this.selectedSpriteIdx<0&&(this.selectedSpriteIdx=this.loadedSprites.length-1);const t=this.loadedSprites[this.selectedSpriteIdx],i=n[t];this.selectedSprite=i,this.setTileButtonAsActive()}renderBackground(e){this.renderForeground(e)}renderForeground(e){}render(i){const s=new e(.5*this.levelSize,.5*this.levelSize);s.x-=this.game.mainCamera.position.x,s.y-=this.game.mainCamera.position.y;let a=0;for(let e=0;e<this.rowMaxCells;e++){for(let e=0;e<this.rowMaxCells;e++)t.drawRectangle(i,s,this.levelSize,this.levelSize,this.pattern[a]),null!==this.grid[a]&&(i.save(),i.filter="contrast(1.3)",t.drawSprite(i,s,this.grid[a],this.levelSize*this.game.mainCamera.cameraZoomAmount,this.levelSize*this.game.mainCamera.cameraZoomAmount),i.restore()),s.x+=this.levelSize,a++;s.x=.5*this.levelSize,s.x-=this.game.mainCamera.position.x,s.y+=this.levelSize}i.save(),i.filter="opacity(0.5) contrast(1.3)",t.drawSprite(i,this.cursorPosition,this.selectedSprite,this.levelSize,this.levelSize),i.restore();const r=e.copy(this.cursorPosition);r.x-=10*this.selectedSprite.name.length/2,r.y+=this.levelSize/1.5,t.drawText(i,this.selectedSprite.name,r,200,"#fff","10px 'Press Start 2P', cursive"),t.drawSprite(i,this.cursorPosition,n.DashedBG,this.levelSize,this.levelSize)}}o.Instance=null;class l{constructor(t,i){this.game=t,this.cameraName=i,this.position=new e,this.cameraZoomAmountMax=2,this.cameraZoomAmount=1,this.smoothing=10,this.id=0,this.speed=500,this.targetPosition=new e,this.id=l.nextId++}render(i){if(!this.game.debug)return;const s=new e(20,this.game.canvasHeight-20),a=new e(.5*this.game.canvasWidth,.5*this.game.canvasHeight);t.drawRectangle(i,a,this.game.canvasWidth,this.game.canvasHeight,"#f00",.1),t.DrawStrokeRect(i,a,"#fff",20,this.game.canvasWidth,this.game.canvasHeight,.5),t.DrawStrokeRect(i,a,"#f00",5,.2*this.game.canvasWidth,.2*this.game.canvasHeight,.5),t.drawText(i,this.cameraName,s,150,"#fff","20px 'Press Start 2P', cursive")}FollowTarget(e){}FollowPosition(){if(!this.targetPosition)return;const e=this.game.DeltaTime*this.speed;this.position.y<this.targetPosition.y&&(this.position.y+=e),this.position.y>this.targetPosition.y&&(this.position.y-=e),this.position.x<this.targetPosition.x&&(this.position.x+=e),this.position.x>this.targetPosition.x&&(this.position.x-=e)}}l.nextId=0;class c{constructor(e,t){this.canvasWidth=e,this.canvasHeight=t,this.mapEditor=new o(this,100),this.lastFrameTime=performance.now(),this.mainCamera=new l(this,"Main Camera"),this.renderable=new Array,this.UI=null,this.editMode=!0,this.debug=!1,this.DeltaTime=1,this.fps=0,this.uiSelectionMenu=new a(this.mapEditor.getSpritesArray())}addObject(e){this.renderable.push(e)}render(e){e.clearRect(0,0,this.canvasWidth,this.canvasHeight),this.mainCamera.FollowPosition(),this.mapEditor.render(e),this.processAI(),this.renderable.forEach((t=>{t.render(e)})),this.UI?.render(e)}processAI(){this.calculateDeltaTime(),this.renderable.forEach((e=>{e.Main?.()}))}checkForCollision(t,i){const s=e.Distance(e.Add(t.collisionPosition,t.position),e.Add(i.collisionPosition,i.position)),a=Math.hypot(s.y,s.x),r=t.collisionRadius+i.collisionRadius;return[a<r,a,r,s]}findObjectByReferenceName(e){for(let t of this.renderable)if(t instanceof i&&t.referenceName===e)return t;return null}findObjectsByReferenceName(e){const t=new Array;for(let i of this.renderable)i.referenceName===e&&t.push(i);return t}findObjectByType(e,t){for(const i of this.renderable)if(i!==t&&i instanceof e&&i)return i;return null}findObjectsByType(e,t){const i=new Array;for(const s of this.renderable)s!==t&&s instanceof e&&s&&i.push(s);return i.length>0?i:null}calculateDeltaTime(){const e=performance.now(),t=e-this.lastFrameTime;this.DeltaTime=t/1e3,this.lastFrameTime=e,this.fps=Math.floor(1e3/t)}}function h(e,t,i){return e>i?i:e<t?t:e}const d=new Audio("Sounds/Music/Chase.ogg"),m=new Audio("Sounds/Music/Stomp.ogg");m.volume=1,d.loop=!0,d.volume=0;class u extends i{constructor(){super(...arguments),this.sprite=n.Guard,this.isChased=!1,this.normalSpeed=200,this.runSpeed=2*this.normalSpeed,this.speed=this.normalSpeed,this.fov=100,this.vibrationsRunner=null,this.running=!1,this.staminaMax=100,this.stamina=this.staminaMax}Main(){const e=navigator.getGamepads()[0];if(this.Move(e),this.isChased&&d.volume<1){this.vibrationsRunner||(this.vibrationsRunner=setInterval(this.DramaticVibrations,1e3)),d.paused&&d.play();const e=h(d.volume+this.game.DeltaTime/10,0,1);d.volume=e}else if(d.volume>0&&!this.isChased){const e=h(d.volume-this.game.DeltaTime/10,0,1);0===e&&(d.currentTime=0,d.pause(),this.vibrationsRunner&&(clearInterval(this.vibrationsRunner),this.vibrationsRunner=null)),d.volume=e}}render(e){super.render(e),this.game.debug&&t.DrawCircle(e,this.position,this.fov,"#ff0",.2)}DramaticVibrations(){const e=navigator.getGamepads()[0];m.paused&&m.play(),e?.vibrationActuator?.playEffect("dual-rumble",{strongMagnitude:d.volume,duration:300})}Move(t){if(t){this.HandleGamePadButtonsInput(t);const i=.4,s=Math.abs(t.axes[0])>i?t.axes[0]:0,a=Math.abs(t.axes[1])>i?t.axes[1]:0,r=new e(s*this.speed*this.game.DeltaTime,a*this.speed*this.game.DeltaTime);this.position.x+=r.x,this.position.y+=r.y}this.position.x+this.collisionRadius>this.game.canvasWidth&&(this.position.x=this.game.canvasWidth-this.collisionRadius),this.position.x<this.collisionRadius&&(this.position.x=this.collisionRadius),this.position.y+this.collisionRadius>this.game.canvasHeight&&(this.position.y=this.game.canvasHeight-this.collisionRadius),this.position.y-this.collisionRadius<0&&(this.position.y=this.collisionRadius)}HandleGamePadButtonsInput(e){this.running=e.buttons[10].pressed,this.running&&this.stamina>1?this.speed=this.runSpeed:this.speed=this.normalSpeed,this.running&&this.stamina>1?this.stamina=h(this.stamina-30*this.game.DeltaTime,1,this.staminaMax):!this.running&&this.stamina<this.staminaMax&&(this.stamina=h(this.stamina+15*this.game.DeltaTime,0,this.staminaMax))}getStaminaPercent(){return this.stamina/this.staminaMax}}class p{constructor(e){this.game=e,this.player=null,this.currentValue=0}render(e){this.player?this.DrawPlayerUI(e):this.player=this.game.findObjectByType(u),this.game.mainCamera.render(e),this.DrawFpsCounter(e)}DrawFpsCounter(i){if(this.game.debug){const s=new e(this.game.canvasWidth),a=new e(200,80),r=20,n=new e(this.game.canvasWidth-.5*a.x+.5*r,.5*a.y-.5*r);t.drawRectangle(i,s,a.x,a.y,"#000"),t.drawText(i,`FPS: ${this.game.fps}`,n,80,"#fff",`${r}px 'Press Start 2P', cursive`)}this.currentValue=h(this.currentValue+100*this.game.DeltaTime,0,200)}DrawPlayerUI(e){}}class g{static async loadSprites(e=!0){return this.makeRequest("Json/_buildin.json")}static async makeRequest(e){const t=await fetch(e);return t.ok?t.json():(console.error(`AssetsLoader.makeRequest(url:string)\nCan't fetch: "${e}"`),null)}}let w=Array();window.addEventListener("load",(async()=>{const t=new Audio("Sounds/Music/music.ogg");t.loop=!0;const i=document.querySelector("canvas#game-canvas"),s=i.getContext("2d");i.height=800,i.width=800;const a=new c(i.width,i.height);a.UI=new p(a),await g.loadSprites().then((e=>w=e)),console.log(w),i.addEventListener("mousemove",(t=>{if(0===n){const i=.5*a.mapEditor.levelSize,s=h(t.offsetX,i,a.canvasWidth),r=h(t.offsetY,i,a.canvasHeight);let n=Math.ceil(s/i),o=Math.ceil(r/i);n%2==0&&n--,o%2==0&&o--;const l=new e(Math.round(n*i),Math.round(o*i));a.mapEditor.cursorPosition=l}})),i.addEventListener("contextmenu",(e=>{e.preventDefault()})),i.addEventListener("mousedown",(e=>{if(t.play(),!a.editMode)return;const i=a.mapEditor;i.calculateGridIndex(),0===e.button&&i.placeSprite(),2===e.button&&i.removeSprite()}));let r,n=0;function o(){const t=navigator.getGamepads()[0];if(t&&(t.buttons[7].pressed&&t.buttons[1].pressed&&(a.debug=!a.debug),a.editMode)){const i=a.mapEditor.cursorPosition,s=a.mapEditor.levelSize,r={minimum:.5*s,maximum:s*(a.mapEditor.rowMaxCells-.5)},n=new e(0,0),o=a.mapEditor;t.buttons[15].pressed&&(n.x=1),t.buttons[14].pressed&&(n.x=-1),t.buttons[12].pressed&&(n.y=-1),t.buttons[13].pressed&&(n.y=1),i.x=h(i.x+s*n.x,r.minimum,r.maximum),i.y=h(i.y+s*n.y,r.minimum,r.maximum),0===n.x&&0===n.y||o.calculateGridIndex(),t.buttons[0].pressed&&o.placeSprite(),t.buttons[1].pressed&&!a.debug&&o.removeSprite(),t.buttons[4].pressed&&(o.changeSprite(-1),t.vibrationActuator?.playEffect("dual-rumble",{duration:100,weakMagnitude:.7})),t.buttons[5].pressed&&(o.changeSprite(1),t.vibrationActuator?.playEffect("dual-rumble",{duration:100,weakMagnitude:.7}))}}window.addEventListener("gamepadconnected",(e=>{r=setInterval(o,100),console.info(`Gamepad connected. ID(${e.gamepad.id})`),n=1})),window.addEventListener("gamepaddisconnected",(e=>{clearInterval(r),r=null,console.info(`Gamepad disconnected. ID(${e.gamepad.id})`),n=0})),window.addEventListener("keydown",(e=>{if(a.editMode){const t=a.mainCamera,i=a.mapEditor.levelSize,s=t.targetPosition;switch(e.key){case"w":s.y+=-i;break;case"s":s.y+=i;break;case"a":s.x+=-i;break;case"d":s.x+=i;break;case"q":a.mapEditor.changeSprite(-1);break;case"e":a.mapEditor.changeSprite(1)}}})),i.addEventListener("wheel",(e=>{const t=a.mainCamera,i=-e.deltaY*a.DeltaTime/100;t.cameraZoomAmount=h(t.cameraZoomAmount+i,.5,t.cameraZoomAmountMax)})),function e(){a.render(s),requestAnimationFrame(e)}()}))})();